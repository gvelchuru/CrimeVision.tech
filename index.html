<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Heatmaps</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
      }
      #floating-panel {
        position: absolute;
        top: 120px;
        left: 5%;
        z-index: 3;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        border-color: aqua;
      }
      #floating-panel {
        left: 5%;
        position: absolute;
        top: 120px;
        z-index: 3;
      }
        #floating{
            position: absolute;
        top: 80px;
        left: 5%;
        z-index: 3;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        border-color: aqua;
            
        }
        #custom{
            background-color: aqua;
            border-radius: 20px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>

  <body>
    <div id="floating-panel">
      <button id = "custom" onclick="toggleHeatmap()">Toggle Heatmap</button><br>
      <button id = "custom" onclick="meters()">Get meters</button><br>
      <button id = "custom" onclick="toggleMarkers()">Toggle markers</button><br>
      <!--button onclick="changeGradient()">Change gradient</button>
      <button onclick="changeRadius()">Change radius</button>
      <button onclick="changeOpacity()">Change opacity</button-->
    </div>
    <div id="floating"> <input id="address"></input> <button onclick="goToAddress()">search</button></div><br>
    <div id="map"></div>
    <script type="text/javascript" src="shineapirequests.js"></script> 
    <script type="text/javascript" src="spdapirequests.js"></script>
    <script>

      // This example requires the Visualization library. Include the libraries=visualization
      // parameter when you first load the API. For example:
      // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=visualization">

      var map, heatmap, geocoder;
      var markers = [];
      var showMarkers = true;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 16,
          // get user loc to replace center
          center: {lat: 47.6062, lng: -122.3321}, // current location is seattle
          mapTypeId: 'satellite'
        });

        
        
        get_meters(map.center.lat(), map.center.lng(), function(data) {
            for(i = 0; i < data.length; i++) {
                makeMarker(data[i]);
            }
        })

        get_crimes(function(data) {
            crime_location = []
            for(i = 0; i < data.length; i++) {
                crime_loc_pos = new google.maps.LatLng(data[i]['location']['latitude'], data[i]['location']['longitude'])
                crime_location.push(crime_loc_pos)
            }
            heatmap = new google.maps.visualization.HeatmapLayer({
              data: crime_location,
              map: map,
              radius: 200,
            });

            google.maps.event.addListener(map, 'zoom_changed', function(){
                if (heatmap){
                    var zoom = map.getZoom();
                    console.log(zoom) // zoom inc as you zoom in
                    if (zoom >= 16){
                        heatmap.set('radius', zoom*13);
                        heatmap.set('dissipating', true);
                    } else if (zoom > 13 && zoom < 16){
                        heatmap.set('radius', zoom*5);
                    } else {
                        heatmap.set('radius', zoom); 
                        heatmap.set('dissipating', true); 
                    }
                }
            });
        })
        
        placeService = new google.maps.places.PlacesService(map);
        var request = {
            location: new google.maps.LatLng(map.center.lat(), map.center.lng()), 
            radius: 500, 
            type: "parking"
        }
        placeService.nearbySearch(request, process);
        
        function process(data, status, pagination) {
           if (status !== google.maps.places.PlacesServiceStatus.OK) {
              return;
           }
           for(i = 0; i < data.length; i++) {
                makeParkMarker(data[i]);
           }
           if (pagination.hasNextPage) {
                //sleep:2;
                console.log(pagination.nextPage());
           }
        }
        
        google.maps.event.addListener(map, 'dragend', function() { get_meters(map.center.lat(), map.center.lng(), function(data) {
            for(i = 0; i < data.length; i++) {
                makeMarker(data[i]);
                var request = {
                    location: new google.maps.LatLng(map.center.lat(), map.center.lng()), 
                    radius: 500, 
                    type: "parking"
                }
                placeService.nearbySearch(request, process);
            }
        }) } );
        geocoder = new google.maps.Geocoder();
      }
      
      function goToAddress() {
        
        geocoder.geocode( { 'address' : $('#address').val() }, function( results, status ) {
            if( status == google.maps.GeocoderStatus.OK ) {

                //In this case it creates a marker, but you can get the lat and lng from the location.LatLng
                map.setCenter( results[0].geometry.location );
                //var marker = new google.maps.Marker( {
                //    map     : map,
                //    position: results[0].geometry.location
                //} );
                function process(data, status, pagination) {
                   if (status !== google.maps.places.PlacesServiceStatus.OK) {
                      return;
                   }
                   for(i = 0; i < data.length; i++) {
                        makeParkMarker(data[i]);
                   }
                   if (pagination.hasNextPage) {
                        //sleep:2;
                        console.log(pagination.nextPage());
                   }
                }
                get_meters(map.center.lat(), map.center.lng(), function(data) {
                    for(i = 0; i < data.length; i++) {
                        makeMarker(data[i]);
                        var request = {
                            location: new google.maps.LatLng(map.center.lat(), map.center.lng()), 
                            radius: 500, 
                            type: "parking"
                        }
                        placeService.nearbySearch(request, process);
                        console.log("asdasda");
                    }
                })
            } else {
                alert( 'Geocode was not successful for the following reason: ' + status );
            }
        } );
      }
       
      /*function get_parking(callback) {
        lat = map.center.lat();
        lng = map.center.lng();
        let options = {
          "url": "https://maps.googleapis.com/maps/api/place/nearbysearch/json?location="+lat+","+lng+"&radius=500&types=parking&sensor=false&key=AIzaSyCtwJcWulORFOV0zq7CFPXjkq85G6Ax8lY",
          "method": "GET",
          "dataType": 'json',
          "processData": false
        }
        console.log("here")

        $.ajax(options).done((response)=>{
            success: callback(response)
        })
      } */
      
      function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
      }

      function changeGradient() {
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
        heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
      }

      function changeRadius() {
        heatmap.set('radius', heatmap.get('radius') ? null : 20);
      }

      function changeOpacity() {
        heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
      }

      function meters() {
        get_meters(map.center.lat(), map.center.lng(), function(data) {
            for(i = 0; i < data.length; i++) {
                makeMarker(data[i]);
            }
        })
      }
      
      // Heatmap data: 500 Points, use lat long from SPD data
      function getPoints() {
        return [
          new google.maps.LatLng(37.782551, -122.445368)
        ];
      }
      function makeMarker(data) {
        contentString = generate_info(data);
        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });
        
        var marker = new google.maps.Marker({ 
            position: {lat: data["Latitude"], lng: data["Longitude"]},
            map: map, 
            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
            visible: showMarkers

        });
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
        markers.push(marker);
      }
      
      function generate_info(data) {
        contentString = '<div><ul>'
        contentString += '<li>Meter ID: ' + data["Meter_ID"] + '</li>'
        contentString += '<li>Hours: ' + data["Hours_of_Operation"] + '</li>'
        contentString += '<li>Area: ' + data["Area"] + '</li>'
        contentString += '</ul></div>'
        return contentString;
      }
      
      function makeParkMarker(data) {
        contentString = generate_park_info(data);
        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });
        //console.log(data);
        var marker = new google.maps.Marker({ 
            position: {lat: data.geometry.location.lat(), lng: data.geometry.location.lng()},
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            map: map,
            visible: showMarkers
        });
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
        markers.push(marker);
      }
      
      function generate_park_info(data) {
        contentString = '<div><ul>'
        contentString += '<li>Name: ' + data.name + '</li>'
        contentString += '<li>Rating: ' + data.rating + '</li>'
        contentString += '<li>Vicinity: ' + data.vicinity + '</li>'
        contentString += '</ul></div>'
        return contentString;
      }
      
      function toggleMarkers() {
        showMarkers = !showMarkers;
        for(i = 0; i < markers.length; i++) {
            markers[i].setVisible(showMarkers);
        }
      }

      
    </script>
    <script async defer
        src= "https://maps.googleapis.com/maps/api/js?key=AIzaSyCtwJcWulORFOV0zq7CFPXjkq85G6Ax8lY &libraries=visualization,places&callback=initMap">
    </script>
  </body>
</html>